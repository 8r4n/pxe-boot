version: '3.8'

services:
  pxe-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pxe-test-server
    environment:
      # Test environment variables
      - DHCP_SUBNET=192.168.1.0
      - DHCP_NETMASK=255.255.255.0
      - DHCP_RANGE_START=192.168.1.100
      - DHCP_RANGE_END=192.168.1.200
      - DHCP_ROUTER=192.168.1.1
      - DHCP_DNS=8.8.8.8
      - NGINX_PORT=8080
      - LOG_LEVEL=debug
    volumes:
      - ./configs:/etc/pxe:ro
      - ./nginx-root:/var/www/html:rw
      - ./logs:/var/log/pxe:rw
      - ./test-results:/test-results:rw
    command: ["/usr/local/bin/start-services.sh"]
    healthcheck:
      test: ["CMD", "curl", "-f", "--max-time", "5", "http://127.0.0.1:8080/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  test-runner:
    image: bash:latest
    volumes:
      - .:/workspace:ro
      - ./test-results:/test-results:rw
    working_dir: /workspace
    command: ["/bin/bash", "-c", "mkdir -p /test-results && ./scripts/run-tests.sh"]
    depends_on:
      pxe-test:
        condition: service_healthy

  security-scan:
    image: docker/docker-bench-security:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: ["docker", "docker-bench-security"]
    environment:
      - DOCKER_BENCH_SECURITY_OPTS=--no-colors

  vuln-scan:
    image: aquasecurity/trivy:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: ["image", "--no-progress", "--exit-code", "1", "pxe-server:latest"]
    environment:
      - TRIVY_TIMEOUT=10m
