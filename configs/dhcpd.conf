# DHCP Server Configuration for PXE Boot
# Production-ready configuration with security and monitoring

# Global options
ddns-update-style none;
authoritative;
log-facility local7;

# Default and maximum lease times
default-lease-time ${DHCP_LEASE_TIME};
max-lease-time ${DHCP_LEASE_TIME};

# DNS configuration
option domain-name "${DHCP_DOMAIN}";
option domain-name-servers ${DHCP_DNS};

# PXE boot configuration - HTTP only
option space pxelinux;
option pxelinux.magic code 208 = string;
option pxelinux.configfile code 209 = text;
option pxelinux.pathprefix code 210 = text;
option pxelinux.reboottime code 211 = unsigned integer 32;

# Subnet configuration
subnet ${DHCP_SUBNET} netmask ${DHCP_NETMASK} {
    # Network range
    range ${DHCP_RANGE_START} ${DHCP_RANGE_END};

    # Router/gateway
    option routers ${DHCP_ROUTER};

    # HTTP PXE boot options
    filename "http://${HTTP_SERVER_IP}:${NGINX_PORT}/pxelinux.0";

    # PXE vendor options
    vendor-option-space pxelinux;
    option pxelinux.magic f1:00:74:7e;
    if exists dhcp-parameter-request-list {
        option dhcp-parameter-request-list = concat(option dhcp-parameter-request-list, f1);
    }

    # Lease times
    default-lease-time ${DHCP_LEASE_TIME};
    max-lease-time ${DHCP_LEASE_TIME};

    # NTP servers (optional)
    # option ntp-servers 192.168.1.10;

    # Network time protocol servers
    # option netbios-name-servers 192.168.1.10;

    # Deny unknown clients by default (uncomment for security)
    # deny unknown-clients;
}

# Static IP reservations for known hosts (optional)
# host workstation1 {
#     hardware ethernet 00:11:22:33:44:55;
#     fixed-address 192.168.1.50;
#     option host-name "workstation1";
# }

# Include additional configuration files if needed
# include "/etc/dhcp/dhcpd.conf.local";

# Logging configuration
on commit {
    set client_ip = binary-to-ascii(10, 8, ".", leased-address);
    set client_mac = binary-to-ascii(16, 8, ":", substring(hardware, 1, 6));
    log(info, concat("DHCPACK: ", client_ip, " to ", client_mac));
}

on release {
    set client_ip = binary-to-ascii(10, 8, ".", leased-address);
    set client_mac = binary-to-ascii(16, 8, ":", substring(hardware, 1, 6));
    log(info, concat("DHCPRELEASE: ", client_ip, " from ", client_mac));
}

on expiry {
    set client_ip = binary-to-ascii(10, 8, ".", leased-address);
    set client_mac = binary-to-ascii(16, 8, ":", substring(hardware, 1, 6));
    log(info, concat("DHCPExpiry: ", client_ip, " from ", client_mac));
}
